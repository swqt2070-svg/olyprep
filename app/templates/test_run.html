{% extends "base.html" %}

{% block title %}Прохождение теста{% endblock %}

{% block content %}
<div class="page-inner">
  <div class="page-header">
    <div class="page-header__title">Проверка темы</div>
    <div class="page-header__subtitle">
      {{ test.title if test is defined else "Без названия" }}
    </div>
  </div>

  {% set q = question %}
  {% set total = total_questions|default(1) %}
  {% set current_num = question_number|default(1) %}

  <div class="card card--wide test-run">
    <div class="test-run__header">
      <div class="test-run__question-counter">
        Вопрос {{ current_num }} из {{ total }}
      </div>
      {% if q and q.max_score is defined %}
        <div class="test-run__max-score">
          Максимальный балл: {{ q.max_score }}
        </div>
      {% endif %}
    </div>

    {# ТЕКСТ ЗАДАЧИ #}
    <div class="test-run__block">
      <div class="test-run__block-title">Текст задачи</div>
      <div class="test-run__question-text">
        {% if q and q.text %}
          {{ q.text | replace('\n', '<br>') | safe }}
        {% else %}
          <em>Текст задачи не задан</em>
        {% endif %}
      </div>
    </div>

    <form method="post" action="">
      {# FastAPI нужен request в форме CSRF не используем #}
      <input type="hidden" name="question_id" value="{{ q.id if q else '' }}">
      <input type="hidden" name="question_number" value="{{ current_num }}">

      {# ОПРЕДЕЛЯЕМ, ЕСТЬ ЛИ ВАРИАНТЫ #}
      {% if q and q.answers is defined %}
        {% set non_empty_answers = q.answers | selectattr("text") | list %}
      {% else %}
        {% set non_empty_answers = [] %}
      {% endif %}

      {% if non_empty_answers|length > 0 %}
        {# ВОПРОС С ВЫБОРОМ ОДНОГО ВАРИАНТА #}
        <div class="test-run__block">
          <div class="test-run__block-title">Выберите один вариант</div>

          <div class="test-run__answers">
            {% for a in non_empty_answers %}
              <label class="answer-option">
                <input
                  type="radio"
                  name="answer_id"
                  value="{{ a.id }}"
                  {% if saved_answer is not none and (saved_answer == a.id or saved_answer == a.text) %}checked{% endif %}
                >
                <span class="answer-option__text">{{ a.text }}</span>
              </label>
            {% endfor %}
          </div>
        </div>
      {% else %}
        {# ВОПРОС С ВВОДОМ ТЕКСТА #}
        <div class="test-run__block">
          <div class="test-run__block-title">Введите ответ</div>
          <textarea
            name="answer_text"
            class="test-run__textarea"
            rows="4"
          >{{ saved_answer or "" }}</textarea>
        </div>
      {% endif %}

      {# НАВИГАЦИЯ ПО ВОПРОСАМ #}
      <div class="test-run__footer">
        <div class="test-run__nav-left">
          <button
            type="submit"
            name="action"
            value="prev"
            class="btn btn--secondary"
            {% if current_num <= 1 %}disabled{% endif %}
          >
            ← Предыдущий
          </button>
        </div>

        <div class="test-run__nav-center">
          {% if total > 1 %}
            <div class="test-run__question-dots">
              {% for i in range(1, total + 1) %}
                <button
                  type="submit"
                  name="goto"
                  value="{{ i }}"
                  class="question-dot {% if i == current_num %}question-dot--active{% endif %}"
                >
                  {{ i }}
                </button>
              {% endfor %}
            </div>
          {% endif %}
        </div>

        <div class="test-run__nav-right">
          {% set last = is_last|default(current_num >= total) %}
          <button
            type="submit"
            name="action"
            value="{{ 'finish' if last else 'next' }}"
            class="btn btn--primary"
          >
            {{ "Завершить тест" if last else "Следующий →" }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}
