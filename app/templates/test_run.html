{% extends "base.html" %}

{% block title %}Прохождение теста{% endblock %}

{% block content %}
<div class="page-container">
    <h1 class="page-title">{{ test.title }}</h1>

    <div class="card">
        <div class="test-header">
            <div>Вопрос {{ order }} из {{ total_questions }}</div>
            <div>Максимальный балл: {{ submission.max_score or 0 }}</div>
        </div>

        <form method="post">
            <input type="hidden" name="question_id" value="{{ question.id }}">
            <input type="hidden" name="answer_type" value="{{ question.answer_type }}">

            <div class="form-group">
                <label class="label-bold">Текст задачи</label>
                <div class="question-text-block">
                    <pre class="question-text">{{ question.text }}</pre>
                </div>
            </div>

            {# В зависимости от типа ответа #}
            {% if question.answer_type in ["text"] %}
                <div class="form-group">
                    <label for="answer_text">Ответ</label>
                    <textarea id="answer_text"
                              name="answer_text"
                              rows="4"
                              class="input-textarea">{{ existing_answer.answer_text if existing_answer else "" }}</textarea>
                </div>

            {% elif question.answer_type in ["single", "one"] %}
                <div class="form-group">
                    <label class="label-bold">Выберите один вариант</label>
                    {% set selected_id = existing_answer.selected_option_ids if existing_answer else "" %}
                    <div class="options-list">
                        {% for opt in options %}
                            <label class="option-row">
                                <input type="radio"
                                       name="selected_option"
                                       value="{{ opt.id }}"
                                       {% if selected_id and (selected_id|string) == (opt.id|string) %}checked{% endif %}>
                                <span>{{ opt.text }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

            {% elif question.answer_type in ["multiple", "many"] %}
                <div class="form-group">
                    <label class="label-bold">Выберите один или несколько вариантов</label>
                    {% set selected_ids = [] %}
                    {% if existing_answer and existing_answer.selected_option_ids %}
                        {% set selected_ids = existing_answer.selected_option_ids.split(",") %}
                    {% endif %}
                    <div class="options-list">
                        {% for opt in options %}
                            <label class="option-row">
                                <input type="checkbox"
                                       name="selected_options"
                                       value="{{ opt.id }}"
                                       {% if (opt.id|string) in selected_ids %}checked{% endif %}>
                                <span>{{ opt.text }}</span>
                            </label>
                        {% endfor %}
                    </div>
                </div>

            {% else %}
                <p>Этот тип задачи пока не поддерживается в новом режиме тестов.</p>
            {% endif %}

            <div class="test-navigation">
                <div class="nav-left">
                    {% if order > 1 %}
                        <button type="submit" name="action" value="prev" class="btn btn-secondary">
                            ← Предыдущий
                        </button>
                    {% endif %}
                </div>

                <div class="nav-center">
                    {# Навигатор по номерам вопросов #}
                    {% for idx in range(1, total_questions + 1) %}
                        {% set is_current = (idx == order) %}
                        {% set is_answered = (idx-1) < total_questions
                                             and (options and False) %}
                        <button type="submit"
                                name="action"
                                value="goto_{{ idx }}"
                                class="btn btn-nav {% if is_current %}btn-nav-current{% endif %}">
                            {{ idx }}
                        </button>
                    {% endfor %}
                </div>

                <div class="nav-right">
                    {% if order < total_questions %}
                        <button type="submit" name="action" value="next" class="btn btn-secondary">
                            Следующий →
                        </button>
                    {% endif %}
                    <button type="submit" name="action" value="finish" class="btn btn-primary">
                        Завершить тест
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
