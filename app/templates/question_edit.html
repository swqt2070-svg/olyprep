{% extends "base.html" %}
{% block title %}Редактирование задачи #{{ question.id }}{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h1 class="mb-0">Редактирование задачи #{{ question.id }}</h1>
    <a href="/ui/questions" class="btn btn-outline-light">К списку задач</a>
</div>

{% if error %}
<div class="alert alert-danger mt-3">{{ error }}</div>
{% endif %}
{% if success %}
<div class="alert alert-success mt-3">{{ success }}</div>
{% endif %}

<form method="post" class="mt-3">
    <div class="mb-3">
        <label class="form-label">Текст задачи *</label>
        <textarea name="text" class="form-control" rows="6" required>{{ question.text }}</textarea>
    </div>

    {% if question.image_path %}
    <div class="mb-3">
        <label class="form-label">Изображение задачи</label><br>
        <img src="{{ question.image_path }}"
             alt="Изображение задачи"
             style="max-width: 420px; max-height: 320px; border-radius: 8px;">
    </div>
    {% endif %}

    <div class="mb-3">
        <label class="form-label" for="answer_type">Тип ответа *</label>
        <select id="answer_type" name="answer_type" class="form-select">
            <option value="text" {% if question.answer_type == 'text' %}selected{% endif %}>Написать текст</option>
            <option value="single" {% if question.answer_type == 'single' %}selected{% endif %}>Выбрать один</option>
        </select>
    </div>

    {# Блок для текстового ответа #}
    <div id="block-text" class="mb-3">
        <label class="form-label">Правильный ответ (текст)</label>
        <input type="text"
               name="correct_text"
               class="form-control"
               value="{{ question.correct or '' }}">
        <div class="form-text">
            Проверка — по строке (без учёта регистра и пробелов по краям).
        </div>
    </div>

    {# Блок для выбора одного варианта #}
    <div id="block-single" class="mb-3">
        <label class="form-label">Варианты ответа</label>
        <div class="table-responsive">
            <table class="table table-dark table-sm align-middle">
                <thead>
                    <tr>
                        <th style="width: 70px;">Верный</th>
                        <th>Текст варианта</th>
                    </tr>
                </thead>
                <tbody>
                    {% for opt in options %}
                    <tr>
                        <td class="text-center">
                            <input type="radio"
                                   name="correct_index"
                                   value="{{ loop.index0 }}"
                                   {% if correct_index is not none and loop.index0 == correct_index %}checked{% endif %}>
                        </td>
                        <td>
                            <input type="text"
                                   name="option_{{ loop.index0 }}"
                                   class="form-control"
                                   value="{{ opt }}">
                        </td>
                    </tr>
                    {% endfor %}
                    {# ещё пара пустых строк для добавления новых вариантов #}
                    {% for i in range(options|length, options|length + 2) %}
                    <tr>
                        <td class="text-center">
                            <input type="radio" name="correct_index" value="{{ i }}">
                        </td>
                        <td>
                            <input type="text"
                                   name="option_{{ i }}"
                                   class="form-control"
                                   value="">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="form-text">
            Отметь один правильный вариант. Пустые строки в конце будут отброшены.
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">Сохранить изменения</button>
</form>

<script>
(function() {
    const selectType = document.getElementById('answer_type');
    const blockText = document.getElementById('block-text');
    const blockSingle = document.getElementById('block-single');

    function updateBlocks() {
        if (!selectType) return;
        if (selectType.value === 'single') {
            blockSingle.style.display = '';
            blockText.style.display = 'none';
        } else {
            blockText.style.display = '';
            blockSingle.style.display = 'none';
        }
    }

    updateBlocks();
    if (selectType) {
        selectType.addEventListener('change', updateBlocks);
    }
})();
</script>
{% endblock %}
