{% extends "base.html" %}
{% block title %}Личный кабинет | OlyPrep{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="page-title">Личный кабинет</div>
        <div class="page-subtitle">
            {% if user.role == 'admin' %}
                Администратор: управление платформой и собственным аккаунтом.
            {% elif user.role == 'teacher' %}
                Преподаватель: работа с заданиями, тестами и результатами учеников.
            {% else %}
                Ученик: смена пароля и просмотр своих тестов.
            {% endif %}
        </div>
    </div>
</div>

<div class="card quick-actions">
    <h2 style="font-size:1.05rem; margin-bottom:0.6rem;">Быстрые действия</h2>
    {% if user.role in ['admin', 'teacher'] %}
        <div class="actions-row">
            <a class="btn btn-primary" href="/ui/questions/new">Создать вопрос</a>
            <a class="btn" href="/ui/questions">Библиотека заданий</a>
            <a class="btn btn-primary" href="/ui/tests/new">Создать тест</a>
            <a class="btn" href="/ui/tests">Список тестов</a>
            <a class="btn" href="/ui/import">Импорт .md/.zip</a>
            {% if user.role == 'admin' %}
                <a class="btn" href="/ui/admin/users">Админка ролей</a>
            {% endif %}
        </div>
    {% else %}
        <div class="actions-row">
            <a class="btn btn-primary" href="/ui/tests">Перейти к тестам</a>
            <a class="btn" href="#student-results">Мои попытки</a>
        </div>
    {% endif %}
</div>

<div class="grid">
    <section class="card">
        <h2 style="font-size:1.1rem;">Профиль</h2>
        <p class="muted" style="margin-top:0.4rem;">
            Почта: <strong>{{ user.email }}</strong><br>
            Роль: <strong>{{ user.role }}</strong>
        </p>

        <hr style="border:none; border-top:1px solid rgba(148,163,184,0.35); margin:1rem 0;">

        <h2 style="font-size:1.0rem;">Смена пароля</h2>
        {% if password_error %}
            <div class="alert alert-error" style="margin-top:0.5rem;">{{ password_error }}</div>
        {% endif %}
        {% if password_success %}
            <div class="alert alert-success" style="margin-top:0.5rem;">{{ password_success }}</div>
        {% endif %}

        <form method="post" action="/ui/account/change-password" class="form" style="margin-top:0.5rem;">
            <div class="field">
                <label class="field-label">Текущий пароль <span>*</span></label>
                <input type="password" name="current_password" required>
            </div>
            <div class="field">
                <label class="field-label">Новый пароль <span>*</span></label>
                <input type="password" name="new_password" required>
            </div>
            <div class="field">
                <label class="field-label">Повторите новый пароль <span>*</span></label>
                <input type="password" name="new_password2" required>
            </div>
            <button type="submit" class="btn btn-primary" style="margin-top:0.3rem;">Обновить пароль</button>
        </form>
    </section>

    <aside class="card">
        <h2 style="font-size:1.05rem;">Рабочая зона</h2>
        {% if user.role in ['admin', 'teacher'] %}
            <ul class="muted" style="margin-top:0.75rem; list-style:none;">
                <li style="margin-bottom:0.45rem;">• Открыть <a href="/ui/questions">библиотеку заданий</a> или <a href="/ui/questions/new">добавить новое</a>.</li>
                <li style="margin-bottom:0.45rem;">• Составить тест в <a href="/ui/tests">конструкторе</a> и задать лимит попыток.</li>
                <li style="margin-bottom:0.45rem;">• Смотреть детальные результаты учеников через кнопку «Детали» в таблице ниже.</li>
                {% if user.role == 'admin' %}
                <li style="margin-bottom:0.45rem;">• Менять роли пользователей в <a href="/ui/admin/users">админке</a>.</li>
                {% endif %}
            </ul>
        {% else %}
            <p class="muted" style="margin-top:0.75rem;">
                Проходите тесты в разделе «Тесты» и следите за своими попытками ниже.
            </p>
        {% endif %}
    </aside>
</div>

{% if student_results %}
<section class="card table-card" style="margin-top:1.5rem;">
    <h2 id="student-results" style="font-size:1.0rem; margin-bottom:0.4rem;">Мои попытки тестов</h2>
    {% if student_results|length == 0 %}
        <p class="muted">Пока нет попыток.</p>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th style="width:60px;">#</th>
                    <th>Тест</th>
                    <th style="width:120px;">Баллы</th>
                    <th style="width:160px;">Дата</th>
                </tr>
            </thead>
            <tbody>
                {% for r in student_results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ r.test.title }}</td>
                        <td>{{ r.submission.score }} / {{ r.max_points }}</td>
                        <td>{% if r.submission.started_at %}{{ r.submission.started_at.strftime("%d.%m.%Y %H:%M") }}{% else %}—{% endif %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</section>
{% endif %}

{% if teacher_results %}
<section class="card table-card" style="margin-top:1.5rem;">
    <h2 style="font-size:1.0rem; margin-bottom:0.4rem;">Результаты учеников</h2>
    {% if teacher_results|length == 0 %}
        <p class="muted">Пока нет попыток учеников.</p>
    {% else %}
        <table>
            <thead>
                <tr>
                    <th style="width:60px;">#</th>
                    <th>Ученик</th>
                    <th>Тест</th>
                    <th style="width:120px;">Баллы</th>
                    <th style="width:160px;">Дата</th>
                    <th style="width:120px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for r in teacher_results %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ r.student.email }}</td>
                        <td>{{ r.test.title }}</td>
                        <td>{{ r.submission.score }} / {{ r.max_points }}</td>
                        <td>{% if r.submission.started_at %}{{ r.submission.started_at.strftime("%d.%m.%Y %H:%M") }}{% else %}—{% endif %}</td>
                        <td><a class="btn btn-sm" href="/ui/submissions/{{ r.submission.id }}">Детали</a></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</section>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
    .quick-actions {
        padding: 16px 18px;
        margin-bottom: 16px;
    }

    .quick-actions .actions-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
</style>
{% endblock %}
