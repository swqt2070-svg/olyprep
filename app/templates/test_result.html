{% extends "base.html" %}

{% block title %}Результаты теста{% endblock %}

{% block content %}
<div class="page-inner page-test-result">
    <h1 class="page-title">Результаты теста «{{ test.title }}»</h1>

    <div class="card card-test-result-summary">
        <div class="result-main">
            <div class="result-score">
                Итоговый балл: <strong>{{ total_score }} / {{ max_total }}</strong>
            </div>
            <div class="result-meta">
                {% if submission %}Попытка #{{ submission.id }}{% endif %}
                {% if student %} · Ученик: {{ student.email }} (id: {{ student.id }}){% endif %}
            </div>
        </div>
    </div>

    <div class="card card-test-result-details">
        <h2 class="card-title">Детализация по задачам</h2>

        <div class="table-wrapper">
            <table class="result-table">
                <thead>
                    <tr>
                    <th>#</th>
                    <th>Задача</th>
                    <th>Ваш ответ</th>
                    <th>Правильный ответ{% if not show_correct|default(true) %} (скрыто){% endif %}</th>
                    <th>Баллы</th>
                    {% if show_self_mark %}<th style="width: 180px;">Самооценка</th>{% endif %}
                    {% if can_edit %}<th style="width: 160px;">Правка</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                    <tr>
                            <td>{{ row.index }}</td>
                            <td class="col-question">
                                {{ row.question.text | replace('\n', '<br>') | safe }}
                            </td>
                            <td class="col-answer">{{ row.your_answer }}</td>
                                <td class="col-answer">
                                    {% if show_correct|default(true) %}
                                        {{ row.correct_answer }}
                                    {% else %}
                                        Скрыто
                                    {% endif %}
                                </td>
                            <td>{{ row.score }} / {{ row.max_points }}</td>
                            {% if show_self_mark %}
                                <td>
                                    {% if row.self_mark_allowed %}
                                        <form method="post" action="/ui/submissions/{{ submission.id }}/self-mark" class="inline-form">
                                            <input type="hidden" name="question_id" value="{{ row.question_id }}">
                                            <button class="btn btn-sm {% if row.self_mark_state %}btn-primary{% endif %}" name="mark" value="correct" type="submit">Верно</button>
                                            <button class="btn btn-sm {% if not row.self_mark_state %}btn-outline{% endif %}" name="mark" value="wrong" type="submit">Неверно</button>
                                        </form>
                                        <div class="muted" style="margin-top:4px;">Доступно только для текстовых вопросов.</div>
                                    {% else %}
                                        —
                                    {% endif %}
                                </td>
                            {% endif %}
                            {% if can_edit %}
                            <td>
                                <form method="post" action="/ui/submissions/{{ submission.id }}/set-points" class="inline-form">
                                    <input type="hidden" name="question_id" value="{{ row.question_id }}">
                                    <input type="number" name="points" min="0" step="1" value="{{ row.score }}" class="points-input">
                                    <button class="btn btn-sm" type="submit">Сохранить</button>
                                </form>
                            </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .page-test-result .card-test-result-summary,
    .page-test-result .card-test-result-details {
        max-width: 1200px;
        margin: 0 auto 24px auto;
        padding: 20px 24px;
    }

    .page-test-result .result-score {
        font-size: 18px;
    }

    .page-test-result .result-meta {
        margin-top: 6px;
        color: #aeb4c5;
        font-size: 13px;
    }

    .page-test-result .table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .page-test-result .result-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }

    .page-test-result .result-table th,
    .page-test-result .result-table td {
        padding: 8px 10px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        vertical-align: top;
    }

    .page-test-result .result-table th {
        text-align: left;
        font-weight: 500;
        color: #aeb4c5;
        white-space: nowrap;
    }

    .page-test-result .col-question {
        min-width: 260px;
    }

    .page-test-result .col-answer {
        min-width: 160px;
    }

    .points-input {
        width: 70px;
        padding: 4px 6px;
        margin-right: 6px;
        border-radius: 6px;
        border: 1px solid rgba(148,163,184,0.35);
        background: rgba(15,23,42,0.6);
        color: #e5e7eb;
    }

    .inline-form {
        display: flex;
        align-items: center;
        gap: 6px;
    }
</style>
{% endblock %}
