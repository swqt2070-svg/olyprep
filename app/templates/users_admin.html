{% extends "base.html" %}
{% block title %}Пользователи — OlyPrep{% endblock %}
{% block content %}
<div class="page-header">
    <div>
        <div class="page-title">Управление пользователями</div>
        <div class="page-subtitle">
            Только администратор может менять роли. Первый зарегистрированный пользователь всегда админ.
        </div>
    </div>
</div>

<section class="card">
    {% if error %}
        <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    {% if success %}
        <div class="alert alert-success">{{ success }}</div>
    {% endif %}

    <h2 style="font-size:1.0rem; margin-bottom:0.4rem;">Список пользователей</h2>

    {% if users|length == 0 %}
        <p class="muted">Пользователей пока нет.</p>
    {% else %}
        <section class="table-card">
            <table>
                <thead>
                    <tr>
                        <th style="width:60px;">ID</th>
                        <th>Почта</th>
                        <th>ФИО</th>
                        <th style="width:120px;">Роль</th>
                        <th style="width:260px;">Статус / Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                        <tr{% if user.id == u.id %} style="background:rgba(34,197,94,0.06);" {% endif %}>
                            <td>#{{ u.id }}</td>
                            <td>
                                {% if user.id == u.id %}
                                    <strong>{{ u.email }}</strong> <span class="muted">(вы)</span>
                                {% else %}
                                    {{ u.email }}
                                {% endif %}
                            </td>
                            <td>{{ u.full_name or '-' }}</td>
                            <td>
                                <span class="badge{% if u.role == 'admin' %} badge-blue{% elif u.role == 'teacher' %} badge-green{% endif %}">
                                    {{ u.role }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex" style="gap:6px; flex-wrap:wrap; align-items:center;">
                                    <span class="badge {% if u.active %}badge-green{% else %}badge-gray{% endif %}">
                                        {% if u.active %}Активен{% else %}Заморожен{% endif %}
                                    </span>
                                    {% if user.id != u.id %}
                                    <form method="post" action="/ui/admin/users/delete" style="display:inline-block;" onsubmit="return confirm('Удалить учётку #{{ u.id }}?');">
                                        <input type="hidden" name="user_id" value="{{ u.id }}">
                                        <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                                    </form>
                                    {% endif %}
                                    <details class="user-edit">
                                        <summary class="btn btn-sm">Редактировать</summary>
                                        <div class="edit-card">
                                            <form method="post" action="/ui/admin/users/update" class="form edit-form">
                                                <input type="hidden" name="user_id" value="{{ u.id }}">
                                                <div class="field">
                                                    <label class="field-label">Почта (логин)</label>
                                                    <input type="email" name="email" required value="{{ u.email }}">
                                                </div>
                                                <div class="field">
                                                    <label class="field-label">ФИО</label>
                                                    <input type="text" name="full_name" value="{{ u.full_name or '' }}">
                                                </div>
                                                <div class="field">
                                                    <label class="field-label">Роль</label>
                                                    <select name="role">
                                                        <option value="student" {% if u.role=='student' %}selected{% endif %}>Ученик</option>
                                                        <option value="teacher" {% if u.role=='teacher' %}selected{% endif %}>Учитель</option>
                                                        <option value="admin" {% if u.role=='admin' %}selected{% endif %}>Админ</option>
                                                    </select>
                                                </div>
                                                <div class="field">
                                                    <label class="field-label">Новый пароль (опционально)</label>
                                                    <input type="password" name="new_password" placeholder="Не менять — оставьте пустым">
                                                </div>
                                                <div class="field">
                                                    <label class="field-label">Статус</label>
                                                    <label style="display:flex; align-items:center; gap:6px;">
                                                        <input type="checkbox" name="active" {% if u.active %}checked{% endif %}>
                                                        Активен (снять галку — заморозить)
                                                    </label>
                                                </div>
                                                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                                    <button type="submit" class="btn btn-primary btn-sm">Сохранить</button>
                                                    <button type="button" class="btn btn-ghost btn-sm" onclick="this.closest('details').open=false;">Закрыть</button>
                                                </div>
                                            </form>
                                        </div>
                                    </details>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    {% endif %}
</section>

<style>
.user-edit summary {
    list-style: none;
}
.user-edit summary::-webkit-details-marker { display:none; }
.user-edit .edit-card {
    margin-top: 8px;
    padding: 10px;
    border-radius: 8px;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(148,163,184,0.2);
}
.edit-form .field {
    margin-bottom: 0.4rem;
}
</style>
{% endblock %}
