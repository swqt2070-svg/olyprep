{% extends "base.html" %}

{% block title %}
    {% if mode == "create" %}Создание теста{% else %}Редактирование теста{% endif %}
{% endblock %}

{% block content %}

<div class="page-header">
    <div>
        <h1 class="page-title">
            {% if mode == "create" %}
                Создание теста
            {% else %}
                Редактирование теста #{{ test.id }}
            {% endif %}
        </h1>
        <p class="page-subtitle">
            Задайте параметры теста и выберите задачи из библиотеки.
        </p>
    </div>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}
{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

<form method="post">
    <input type="hidden" name="view_mode" value="{{ view_mode if view_mode is defined else 'nested' }}">
    {# Карточка с настройками теста #}
    <div class="card" style="margin-bottom:1.5rem;">
        <div class="card-body">
            <div class="field">
                <label for="title" class="field-label">
                    Название теста <span>*</span>
                </label>
                <input type="text"
                       id="title"
                       name="title"
                       value="{{ test.title if test else '' }}"
                       required>
            </div>

            <div class="field" style="margin-top:0.8rem;">
                <label for="description" class="field-label">Описание</label>
                <textarea id="description"
                          name="description"
                          rows="3">{{ test.description if test else '' }}</textarea>
            </div>

            <div class="test-grid" style="margin-top:1rem;">
                <div class="field">
                    <label for="max_attempts" class="field-label">
                        Максимум попыток (0 — без ограничений)
                    </label>
                    <input type="number"
                           id="max_attempts"
                           name="max_attempts"
                           min="0"
                           value="{{ max_attempts if max_attempts is defined else (test.max_attempts if test and test.max_attempts is not none else 0) }}">
                </div>
                <div class="field" style="justify-content:flex-end;">
                    <label class="field-label">Показ ответов</label>
                    <label style="font-size:0.85rem; display:flex; align-items:center; gap:0.4rem;">
                        <input type="checkbox"
                               name="show_correct_answers"
                               {% if test and test.show_correct_answers %}checked{% elif not test %}checked{% endif %}>
                        Показывать правильные ответы после завершения теста
                    </label>
                </div>
            </div>
        </div>
    </div>

    {# Блок выбора вопросов - дизайн как в библиотеке задач #}
    <h2 class="page-title" style="font-size:1.25rem;">Выберите вопросы из библиотеки</h2>
    <div style="display:flex; gap:1rem; flex-wrap:wrap; align-items:center; margin-bottom:0.25rem;">
        <div class="muted">Режим группировки:</div>
        <select onchange="window.location='?view='+this.value;" class="field-input" style="padding:6px 10px; min-width:200px;">
            <option value="nested" {% if view_mode=='nested' %}selected{% endif %}>Категория → Класс → Год → Этап</option>
            <option value="category" {% if view_mode=='category' %}selected{% endif %}>По категории</option>
            <option value="grade" {% if view_mode=='grade' %}selected{% endif %}>По классу</option>
        </select>
    </div>
    <p class="muted" style="margin-top:0.25rem;">
        Отметьте чекбокс «В тест», чтобы добавить задачу. По умолчанию за каждый вопрос начисляется 1 балл.
    </p>

    {% if not library %}
        <p class="muted" style="margin-top:1rem;">Пока нет вопросов в библиотеке.</p>
    {% else %}

    <div class="library-tree" style="margin-top:1rem;">
        {% if view_mode == 'category' %}
            {% for category, questions in library|dictsort %}
            <details class="lib-level lib-category" {% if loop.first %}open{% endif %}>
                <summary class="lib-summary"><strong>Категория:</strong> {{ category }}</summary>
                <div class="table-card">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:70px;">В тест</th>
                            <th style="width:60px;">ID</th>
                            <th>Текст</th>
                            <th style="width:90px;">Класс</th>
                            <th style="width:90px;">Год</th>
                            <th style="width:120px;">Этап</th>
                            <th style="width:120px;">Тип</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for q in questions %}
                            {% set tq = selected.get(q.id) if selected else None %}
                            <tr>
                                <td style="text-align:center;">
                                    <input type="checkbox" name="q_{{ q.id }}_include" class="builder-checkbox" {% if tq %}checked{% endif %}>
                                    <input type="hidden" name="q_{{ q.id }}_points" value="1">
                                </td>
                                <td>#{{ q.id }}</td>
                                <td>{{ q.text | truncate(140, True, '…') }}</td>
                                <td>{{ q.grade or '-' }}</td>
                                <td>{{ q.year or '-' }}</td>
                                <td>{{ q.stage or '-' }}</td>
                                <td>{% if q.answer_type == "single" %}Выбрать один{% else %}Написать текст{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
            {% endfor %}
        {% elif view_mode == 'grade' %}
            {% for grade, questions in library|dictsort %}
            <details class="lib-level lib-grade" {% if loop.first %}open{% endif %}>
                <summary class="lib-summary"><strong>Класс:</strong> {{ grade }}</summary>
                <div class="table-card">
                    <table>
                        <thead>
                        <tr>
                            <th style="width:70px;">В тест</th>
                            <th style="width:60px;">ID</th>
                            <th>Текст</th>
                            <th style="width:180px;">Категория</th>
                            <th style="width:90px;">Год</th>
                            <th style="width:120px;">Этап</th>
                            <th style="width:120px;">Тип</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for q in questions %}
                            {% set tq = selected.get(q.id) if selected else None %}
                            <tr>
                                <td style="text-align:center;">
                                    <input type="checkbox" name="q_{{ q.id }}_include" class="builder-checkbox" {% if tq %}checked{% endif %}>
                                    <input type="hidden" name="q_{{ q.id }}_points" value="1">
                                </td>
                                <td>#{{ q.id }}</td>
                                <td>{{ q.text | truncate(140, True, '…') }}</td>
                                <td>{{ q.category or '-' }}</td>
                                <td>{{ q.year or '-' }}</td>
                                <td>{{ q.stage or '-' }}</td>
                                <td>{% if q.answer_type == "single" %}Выбрать один{% else %}Написать текст{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
            {% endfor %}
        {% else %}
            {% for category, grades in library|dictsort %}
            <details class="lib-level lib-category" {% if loop.first %}open{% endif %}>
                <summary class="lib-summary">
                    <strong>Категория:</strong> {{ category }}
                </summary>

                {% for grade, years in grades|dictsort %}
                <details class="lib-level lib-grade">
                    <summary class="lib-summary">
                        <strong>Класс:</strong>
                        {% if grade == 0 %}&mdash;{% else %}{{ grade }}{% endif %}
                    </summary>

                    {% for year_code, stages in years|dictsort %}
                    {% set code = year_code|string %}
                    {% if code and code|length == 4 %}
                        {% set y1 = ('20' ~ code[0:2])|int %}
                        {% set y2 = ('20' ~ code[2:4])|int %}
                        {% set year_label = y1 ~ '-' ~ y2 %}
                    {% else %}
                        {% set year_label = code %}
                    {% endif %}

                    <details class="lib-level lib-year">
                        <summary class="lib-summary">
                            <strong>Год:</strong> {{ year_label or '-' }}
                        </summary>

                        {% for stage, questions in stages|dictsort %}
                        <details class="lib-level lib-stage">
                            <summary class="lib-summary">
                                <strong>Этап:</strong> {{ stage or '-' }}
                            </summary>

                            <div class="table-card">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width:70px;">В тест</th>
                                            <th style="width:60px;">ID</th>
                                            <th>Задача</th>
                                            <th style="width:150px;">Тип</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for q in questions %}
                                        {% set tq = selected.get(q.id) if selected else None %}
                                        <tr>
                                            <td style="text-align:center;">
                                                <input type="checkbox"
                                                       name="q_{{ q.id }}_include"
                                                       class="builder-checkbox"
                                                       {% if tq %}checked{% endif %}>
                                                <input type="hidden"
                                                       name="q_{{ q.id }}_points"
                                                       value="1">
                                            </td>
                                            <td>#{{ q.id }}</td>
                                            <td>
                                                <div style="display:flex; align-items:flex-start; gap:0.5rem;">
                                                    {% if q.image_path %}
                                                    <div class="question-thumb-wrapper">
                                                        <img src="{{ q.image_path }}"
                                                             alt="Изображение задачи"
                                                             class="question-thumb">
                                                        </div>
                                                    {% endif %}
                                                    <div class="question-text">
                                                        {{ q.text | truncate(180, True, '…') }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                {% if q.answer_type == "single" %}
                                                    Выбрать один
                                                {% else %}
                                                    Написать текст
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>

                        </details>
                        {% endfor %}

                    </details>
                    {% endfor %}

                </details>
                {% endfor %}

            </details>
            {% endfor %}
        {% endif %}
    </div>
    {% endif %}

    <div style="margin-top:1.5rem; display:flex; gap:0.6rem;">
        <button type="submit" class="btn btn-primary">
            {% if mode == "create" %}Создать тест{% else %}Сохранить изменения{% endif %}
        </button>
        <a href="/ui/tests" class="btn btn-ghost">Отмена</a>
    </div>
</form>

{# стили #}
<style>
    .lib-level {
        margin-bottom: 0.5rem;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.03);
        padding: 0.4rem 0.6rem;
    }
    .lib-summary {
        cursor: pointer;
        list-style: none;
        font-weight: 500;
    }
    .lib-summary::-webkit-details-marker {
        display: none;
    }
    .lib-summary::before {
        content: "›";
        display: inline-block;
        margin-right: 0.4rem;
        transition: transform 0.15s ease-out;
        opacity: 0.7;
    }
    details[open] > .lib-summary::before {
        transform: rotate(90deg);
    }
    .question-thumb {
        max-width: 80px;
        max-height: 60px;
        object-fit: cover;
        border-radius: 6px;
    }
    .builder-checkbox {
        transform: scale(1.05);
        cursor: pointer;
    }
</style>

{% endblock %}
